Title Further analysis plan of hypertension
========================================================

```{r}
source("D:/Users/tao.xu/Documents/R-studio git/CVD/CVD/Toolkits.R")
setwd("D:/Users/tao.xu/Dropbox/Cardiovascular disease")
load("data_hypertension_new.RData")

```

Some important Variables included in the dataset:

a. BP_associat: Blood pressure associated metabolites in the prospective analysis, including `r colnames(BP_associat)`.
b. cs_asso: Hypertension associated metabolites in cross sectional analysis, including `r colnames(cs_asso)`.

1. Subgroup the metabolites and plan further analysis strategies.
We tried here two criterias to determin wheter one metabolite is associated with hypertension or blood press.
i. _The relaxed criteria_: metabolites significantly associated with hypertension or diastolic/systolic- blood pressure in at least two analysis, either cross-sectional or prospective.
ii. _The stringent criteria_: metabolites significantly associated with hypertension or diastolic/systolic- blood pressure in both cross-sectional analysis and prospective analysis.
```{r}
asso.hyer=apply(cs_asso[,grep("_nom", colnames(cs_asso))], 1, function(x) sum(x!=0))
metabo.asso.hyper.strin=names(which(asso.hyer==3))
metabo.asso.hyper.relax=names(which(asso.hyer>=2))

indx.all=grep("_all", colnames(BP_associat))
indx.medi=grep("_nom", colnames(BP_associat))
indx.sys=grep("sys", colnames(BP_associat))
indx.dia=grep("dia", colnames(BP_associat))

asso.dia=apply(BP_associat[,intersect(indx.all, indx.dia)], 1, function(x) sum(x!=0))
metabo.asso.dia.strin=names(which(asso.dia==3))
metabo.asso.dia.relax=names(which(asso.dia>=2))

asso.sys=apply(BP_associat[,intersect(indx.all, indx.sys)], 1, function(x) sum(x!=0))
metabo.asso.sys.strin=names(which(asso.sys==3))
metabo.asso.sys.relax=names(which(asso.sys>=2))
````
Among these metabolites, `r intersect(metabo.asso.hyper.strin, metabo.asso.dia.strin)` are associated with both hypertension  and diastolic blood pressure; `r  intersect(metabo.asso.hyper.strin, metabo.asso.sys.strin)` are associated with both hypertension and systolic blood pressure.


a. As metioned in the [literature][1], PCA could be used to reduce the redundent information in the metabolite profile. We applied the same method in our analysis, a) involve the the principle components have eigen values greater than 1, b)metabolite with a factor load __>0.4__ were reported as composing  a factor. Principle component factor scorre were calculated for each participants.
```{r}
##S4
tmp=scale(log(S4[,metabo.asso.hyper.relax]))
pc.S4=prcomp(tmp)
index.pcs=which(pc.S4$sdev^2>1)
apply(pc.S4$rotation[, index.pcs], 2, function(x) which(abs(x)>=0.3))

##F4
tmp=scale(log(F4[,metabo.asso.hyper.relax]))
tmp=na.omit(tmp)
pc.F4=prcomp(tmp)
index.pcs=which(pc.F4$sdev^2>1)
apply(pc.F4$rotation[, index.pcs], 2, function(x) which(abs(x)>=0.3))

##pooled
tmp=rbind(scale(log(F4[,valid_measures])), scale(log(S4[,valid_measures])))
tmp=na.omit(tmp)
pc.all=prcomp(tmp)
index.pcs=which(pc.all$sdev^2>1)
apply(pc.all$rotation[, index.pcs], 2, function(x) which(x>=0.2))
```

However, as the results showed, no PC passed the criteria. The reason for the unsuccessful usage of the method in the analysis could be attributed to the high variation between the two groups, while in the [literature][1] the method was applied on a matched case-control dataset, which had less variation within groups.

b.As suggested by Annette, we tried fator analysis to find the hidden factors influencing the metabolites that associated with hypertension. 
```{r}
tmp=S4[,c(metabo.asso.hyper.relax)]
tmp=na.omit(tmp)
factanal(tmp, 4, rotation="varimax")
```
By this kind of factor analysis, we can only find the classes of hypertension or blood pressure associated metabolites. But in this metabolite panel, it is quite easy to distinguish classes of metabolites, so we think it will not help much in the analysis.

c.how is the relatioship between blood pressure with the metabolites associated with hypertension. As we mentioned above, `r intersect(metabo.asso.hyper.strin, metabo.asso.dia.strin)` are associated with both hypertension and diastolic blood pressure under the stringent criteria; `r intersect(metabo.asso.hyper.relax, metabo.asso.dia.relax)` are asspciated both under relaxed criteria.
```{r}
metabo.dif = setdiff(metabo.asso.hyper.strin, metabo.asso.sys.strin)

sysbp.quintile = cut(S4$ltsysmm, breaks = quantile(S4$ltsysmm, probs = seq(0, 1, 0.2),na.rm = TRUE), include.lowest = T,ordered_result = F)
plotmeans(S4$Met~sysbp.quintile)

sysbp.quintile = cut(F4$utsysmm, breaks = quantile(F4$utsysmm, probs = seq(0, 1, 0.2),na.rm = TRUE), include.lowest = T,ordered_result = F)
plotmeans(F4$Tyr~sysbp.quintile)

```

2. Are the hypertension associated metabolites predictive of furture hypertension
```{r fig.width=3, fig.height=3}
require(pROC)
metabo.asso = names(which(apply(cs_asso[,c(2,4,6)],1,function(x) sum(x!=0))==3))
metabo.diaBPasso = names(which(apply(BP_associat[,c(1,3)],1,function(x) sum(x!=0))==2))
metabo.sysBPasso = names(which(apply(BP_associat[,c(2,4)],1,function(x) sum(x!=0))==2))
clinical = c("ltalteru", "lcsex", "ltsysmm", "ltbmi", "my.alkkon", "my.cigreg", "my.diab", "ll_hdla", "ll_chola", "lh_crp")

##generate cross-validation set
cv_set = f_K_fold(length(which(S4$lthyact==2)), 10)

## glm extension for model evaluation by cross validation 
glm.cv = function(x, f, data, outcome, variable, subset){
  #print(x)
  s = subset[x[[1]]]
  #print(s)
  if(!is.formula(f)){
    stop("It is not a formula!")
  }
  model = glm(f, data = data[s,c(outcome, variable)], family = binomial)
  pred = predict(model ,data[subset[x[[2]]], c(outcome,variable)], type = "response")
  return(pred)
}

pred = lapply(cv_set, glm.cv, f = formula(my.uthyact~.), data = S4, outcome = "my.uthyact", variable = c(metabo.asso, clinical), subset = which(S4$lthyact==2))
pred = unlist(pred)
pred = pred[rownames(S4)[which(S4$lthyact==2)]]
roc.all = roc(S4$my.uthyact[which(S4$lthyact==2)], pred)


pred = lapply(cv_set, glm.cv, f = formula(my.uthyact~.), data = S4, outcome = "my.uthyact", variable = c(metabo.asso), subset = which(S4$lthyact==2))
pred = unlist(pred)
pred = pred[rownames(S4)[which(S4$lthyact==2)]]
roc.metab = roc(S4$my.uthyact[which(S4$lthyact==2)], pred)

pred = lapply(cv_set, glm.cv, f = formula(my.uthyact~.), data = S4, outcome = "my.uthyact", variable = c(clinical), subset = which(S4$lthyact==2))
pred = unlist(pred)
pred = pred[rownames(S4)[which(S4$lthyact==2)]]
roc.clinical = roc(S4$my.uthyact[which(S4$lthyact==2)], pred, ci = TRUE)


plot(roc.all, print.auc = TRUE, grid=TRUE, print.auc.y=ifelse(roc.all$percent, 50, .5))
plot(roc.metabo, add =T,print.auc = TRUE, grid=TRUE, print.auc.y=ifelse(roc.metabo$percent, 60, .6), col = "green")
plot(roc.clinical, add =T,print.auc = TRUE, grid=TRUE, print.auc.y=ifelse(roc.clinical$percent, 70, .7), col = "blue")

```

Using some variable selection methods:
```{r}
require(caret)
data = S4[which(S4$lthyact==2), c(metabo.asso, clinical, "my.uthyact")]
data = na.omit(data)

inTraining = createDataPartition(data$my.uthyact, times =1, p = 0.66, list=T)
training <- data[inTraining[[1]], ]
testing <-data[-inTraining[[1]],]

fitcontrol = trainControl(method = "repeatedcv", number = 10, repeats=10)
#glmFit1 = train(x = training[, c(metabo.asso, clinical)], y = as.factor(training$my.uthyact), method = "glm", family = binomial, trControl=fitcontrol)
#predict(glmFit1$finalModel, testing, type = "response")

##using boosting for variable selection
glmFit1 = train(x = training[, c(metabo.asso, clinical)], y = as.factor(training$my.uthyact), method = "glmboost", family = Binomial(link="logit"), trControl=fitcontrol)
pred = predict(glmFit1$finalModel, as.matrix(testing[,c(metabo.asso, clinical)]), type = "response")
roc.all = roc(testing$my.uthyact,pred)

glmFit1 = train(x = training[, c(metabo.asso)], y = as.factor(training$my.uthyact), method = "glmboost", family = Binomial(link="logit"), trControl=fitcontrol)
pred = predict(glmFit1$finalModel, as.matrix(testing[,c(metabo.asso)]), type = "response")
roc.metabo = roc(testing$my.uthyact,pred)

glmFit1 = train(x = training[, c(clinical)], y = as.factor(training$my.uthyact), method = "glmboost", family = Binomial(link="logit"), trControl=fitcontrol)
pred = predict(glmFit1$finalModel, as.matrix(testing[,c(clinical)]), type = "response")
roc.clinical = roc(testing$my.uthyact,pred)

```


Some other things shoud be put on Todo list:
3. Different medication information could be applied from Margert Heir, who is repsponsible for coding of the medications.


[1]: http://circgenetics.ahajournals.org/content/3/2/207.long "Association of a Peripheral Blood Metabolic Profile With Coronary Artery Disease and Risk of Subsequent Cardiovascular Events"