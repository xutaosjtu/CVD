Title Further analysis plan of hypertension
========================================================

```{r}
source("D:/Users/tao.xu/Documents/R-studio git/CVD/CVD/Toolkits.R")
setwd("D:/Users/tao.xu/Dropbox/Cardiovascular disease")
load("data_hypertension_new.RData")

##remove outliers
S4[,valid_measures] = apply(S4[,valid_measures], 2, function(x) {x[outlier(x)]=NA;return(x)})
F4[,valid_measures] = apply(F4[,valid_measures], 2, function(x) {x[outlier(x)]=NA;return(x)})
```



Some important Variables included in the dataset:

a. BP_associat: Blood pressure associated metabolites in the prospective analysis, including `r colnames(BP_associat)`.
b. cs_asso: Hypertension associated metabolites in cross sectional analysis, including `r colnames(cs_asso)`.

1. Subgroup the metabolites and plan further analysis strategies.
We tried here two criterias to determin wheter one metabolite is associated with hypertension or blood press.
i. _The relaxed criteria_: metabolites significantly associated with hypertension or diastolic/systolic- blood pressure in at least two analysis, either cross-sectional or prospective.
ii. _The stringent criteria_: metabolites significantly associated with hypertension or diastolic/systolic- blood pressure in both cross-sectional analysis and prospective analysis.
```{r}
asso.hyer=apply(cs_asso[,grep("_all", colnames(cs_asso))], 1, function(x) sum(x!=0))
metabo.asso.hyper.strin=names(which(asso.hyer==3))
metabo.asso.hyper.relax=names(which(asso.hyer>=2))

indx.all=grep("_all", colnames(BP_associat))
indx.medi=grep("_nom", colnames(BP_associat))
indx.sys=grep("sys", colnames(BP_associat))
indx.dia=grep("dia", colnames(BP_associat))

asso.dia=apply(BP_associat[,intersect(indx.all, indx.dia)], 1, function(x) sum(x!=0))
metabo.asso.dia.strin=names(which(asso.dia==3))
metabo.asso.dia.relax=names(which(asso.dia>=2))

asso.sys=apply(BP_associat[,intersect(indx.all, indx.sys)], 1, function(x) sum(x!=0))
metabo.asso.sys.strin=names(which(asso.sys==3))
metabo.asso.sys.relax=names(which(asso.sys>=2))
````
Among these metabolites, `r intersect(metabo.asso.hyper.strin, metabo.asso.dia.strin)` are associated with both hypertension  and diastolic blood pressure; `r  intersect(metabo.asso.hyper.strin, metabo.asso.sys.strin)` are associated with both hypertension and systolic blood pressure.


a. As metioned in the [literature][1], PCA could be used to reduce the redundent information in the metabolite profile. We applied the same method in our analysis, a) involve the the principle components have eigen values greater than 1, b)metabolite with a factor load __>0.4__ were reported as composing  a factor. Principle component factor scorre were calculated for each participants.
```{r}
##S4
tmp=scale(log(S4[,metabo.asso.hyper.relax]))
pc.S4=prcomp(tmp)
index.pcs=which(pc.S4$sdev^2>1)
apply(pc.S4$rotation[, index.pcs], 2, function(x) which(abs(x)>=0.3))

##F4
tmp=scale(log(F4[,metabo.asso.hyper.relax]))
tmp=na.omit(tmp)
pc.F4=prcomp(tmp)
index.pcs=which(pc.F4$sdev^2>1)
apply(pc.F4$rotation[, index.pcs], 2, function(x) which(abs(x)>=0.3))

##pooled
tmp=rbind(scale(log(F4[,valid_measures])), scale(log(S4[,valid_measures])))
tmp=na.omit(tmp)
pc.all=prcomp(tmp)
index.pcs=which(pc.all$sdev^2>1)
apply(pc.all$rotation[, index.pcs], 2, function(x) which(x>=0.2))
```

However, as the results showed, no PC passed the criteria. The reason for the unsuccessful usage of the method in the analysis could be attributed to the high variation between the two groups, while in the [literature][1] the method was applied on a matched case-control dataset, which had less variation within groups.

b.As suggested by Annette, we tried fator analysis to find the hidden factors influencing the metabolites that associated with hypertension. 
```{r}
tmp=S4[,c(metabo.asso.hyper.relax)]
tmp=na.omit(tmp)
factanal(tmp, 4, rotation="varimax")
```
By this kind of factor analysis, we can only find the classes of hypertension or blood pressure associated metabolites. But in this metabolite panel, it is quite easy to distinguish classes of metabolites, so we think it will not help much in the analysis.

c.how is the relatioship between blood pressure with the metabolites associated with hypertension. As we mentioned above, `r intersect(metabo.asso.hyper.strin, metabo.asso.dia.strin)` are associated with both hypertension and diastolic blood pressure under the stringent criteria; `r intersect(metabo.asso.hyper.relax, metabo.asso.dia.relax)` are asspciated both under relaxed criteria.
```{r}

S4$sysbp.quintile = cut(S4$ltsysmm, breaks = c(90,seq(5)*10+100,300), include.lowest = T,ordered_result = F, right=F)
S4$diabp.quintile=cut(S4$ltdiamm, breaks = c(60,seq(4)*10+60), include.lowest = T,ordered_result = F, right=F)
F4$sysbp.quintile = cut(F4$utsysmm, breaks = c(90,seq(5)*10+100,300), include.lowest = T,ordered_result = F, right=F)
F4$diabp.quintile = cut(F4$utdiamm, breaks = c(60,seq(4)*10+60), include.lowest = T,ordered_result = F, right=F)

metabo.dif = setdiff(metabo.asso.hyper.strin, c(metabo.asso.sys.strin, metabo.asso.dia.strin))
tmp=residue(data=S4, Metabolites=metabo.dif, adj=clinical, control_group=which(S4$lthyact==2))
tmp2=residue(data=F4, Metabolites=metabo.dif, adj=clinical.f4, control_group=which(F4$uthyact==2))

pdf("sysBP association with hyper associated metabolites.pdf", width=10, height=8)
par(mfrow = c(3,3))
for(m in metabo.dif){
  plotmeans(tmp[,m]~sysbp.quintile, data=S4, main=m, ylab="residue", xlab="systolicBP")
  #i1=which(F4$utantihy==2)
  plotmeans(tmp2[, m]~sysbp.quintile, data=F4, add=T, col="grey")
}
dev.off()

pdf("diaBP association with hyper associated metabolites.pdf", width=10, height=8)
par(mfrow = c(3,3))
for(m in metabo.dif){
  i1=which(S4$ltantihy==2)
  plotmeans(tmp[i1,m]~diabp.quintile, data=S4[i1,], main=m, ylab="residue", xlab="systolicBP")
  i1=which(F4$utantihy==2)
  plotmeans(tmp2[i1, m]~diabp.quintile, data=F4[i1,], add=T, col="grey")
}
dev.off()

pdf("systolic BP association with metabolite_medi.pdf", width=10, height=8)
par(mfrow = c(3,3))
for(m in metabo.dif){
  i1=which(S4$ltantihy==1&S4$lthyact==1);i2=which(S4$ltantihy==2&S4$lthyact==1)
  plotmeans(tmp[i1,m]~sysbp.quintile, data=S4[i1,], main=m, ylab="residue", xlab="systolicBP", col = "blue")
  plotmeans(tmp[i2,m]~sysbp.quintile, data=S4[i2,], main=m, ylab="residue", xlab="systolicBP", col="lightblue",add=T)
  #plot(tmp[,m]~ltsysmm, data=S4, col="grey")
  i1=which(F4$utantihy==1&F4$uthyact==1);i2=which(F4$utantihy==2&F4$uthyact==1)
  plotmeans(tmp2[i1, m]~sysbp.quintile, data=F4[i1,], add=T)
  plotmeans(tmp2[i2, m]~sysbp.quintile, data=F4[i2,], add=T, col="grey")
}
dev.off()

metabo.dif = setdiff(metabo.asso.hyper.strin, c(metabo.asso.dia.strin))
tmp=residue(data=S4, Metabolites=metabo.dif, adj=clinical, control_group=which(S4$lthyact==2))
tmp2=residue(data=F4, Metabolites=metabo.dif, adj=clinical.f4, control_group=which(F4$uthyact==2))

pdf("distolic BP association with metabolite_medi.pdf", width =10, height = 8)
par(mfrow = c(3,3))
for(m in metabo.dif){
  plotmeans(tmp[which(S4$ltantihy==1),m]~diabp.quintile, data=S4[which(S4$ltantihy==1),], main=m, ylab="residue", xlab="systolicBP", col="blue")
  plotmeans(tmp[which(S4$ltantihy==2),m]~diabp.quintile, data=S4[which(S4$ltantihy==2),], main=m, ylab="residue", xlab="systolicBP", col="lightblue",add=T)
  #plot(tmp[,m]~ltsysmm, data=S4, col="grey")
  plotmeans(tmp2[which(F4$utantihy==1),m]~diabp.quintile, data=F4[which(F4$utantihy==1),], add=T)
  plotmeans(tmp2[which(F4$utantihy==2),m]~diabp.quintile, data=F4[which(F4$utantihy==2),], add=T, col="grey")
}
dev.off()

```
From these figures we found no clear pattern of these metabolites in association with diastolic or systolic blood pressure, which provides negative support for the hypothesis that the metabolites associated with hypertension rather than blood pressure were associated in a non linear pattern.

However, these metabolites that associated with hypertension but not with blood pressure could either be an medication effect, or reveals complications of hypertenion or change of lifestyle.

But first we checked if it is influenced by antihypertensive medication. We checked if the metabolites were associated with hypertension after removing of the participants taking antihypertensive drugs. After removing medication the metabolites:
```{r}
asso.hyer=apply(cs_asso[,grep("nom", colnames(cs_asso))], 1, function(x) sum(x!=0))
metabo.asso.hyper.strin=names(which(asso.hyer==3))
metabo.asso.hyper.relax=names(which(asso.hyer>=2))

indx.all=grep("_all", colnames(BP_associat))
indx.medi=grep("_nom", colnames(BP_associat))
indx.sys=grep("sys", colnames(BP_associat))
indx.dia=grep("dia", colnames(BP_associat))

asso.dia=apply(BP_associat[,intersect(indx.medi, indx.dia)], 1, function(x) sum(x!=0))
metabo.asso.dia.strin=names(which(asso.dia==3))
metabo.asso.dia.relax=names(which(asso.dia>=2))

asso.sys=apply(BP_associat[,intersect(indx.medi, indx.sys)], 1, function(x) sum(x!=0))
metabo.asso.sys.strin=names(which(asso.sys==3))
metabo.asso.sys.relax=names(which(asso.sys>=2))

intersect(metabo.dif, metabo.asso.hyper.strin)
```
These metabolites still associated with hypertension after exclusion of medicaition, which indicated an association not influenced by medication.

However, the rest, `r setdiff(metabo.dif, metabo.asso.hyper.strin)`, were potentially associated with medication or lack of statistical power to find the significance in the subgroup without medication. We used here a logistic model with dummy variable of medication to test if the association truely exists.
```{r}
##S4
rst = NULL
for(m in setdiff(metabo.dif, metabo.asso.hyper.strin)){
  S4$m = S4[,m]
  model=glm(as.factor(2-ltantihy) ~ m 
            + ltalteru + as.factor(lcsex) # basic model
  				+ scale(ltbmi) # multivariate model
					+ as.factor(my.cigreg) + as.factor(my.alkkon)
					+ my.diab
					+ scale(ll_chola) + scale(ll_hdla)
					+ scale(log(lh_crp)), 
            data=S4, 
            family=binomial)
  rst=rbind(rst,summary(model)$coef[2,])
}
rownames(rst)=setdiff(metabo.dif, metabo.asso.hyper.strin)

##F4
rst = NULL
for(m in setdiff(metabo.dif, metabo.asso.hyper.strin))
{
  F4$m = F4[,m]
  model=glm(as.factor(2-utantihy) ~ m 
          +utalteru + as.factor(ucsex) ## model 1
  				+ scale(utbmi) # multivariate model
					+ as.factor(my.cigreg) + as.factor(my.alkkon)
					+ my.diab
					+ scale(ul_chola) + scale(ul_hdla)
					+ scale(log(uh_crp)), 
            data=F4, 
            family=binomial)
  rst=rbind(rst,summary(model)$coef[2,])
}
rownames(rst)=setdiff(metabo.dif, metabo.asso.hyper.strin)
```
We found significant association of these metabolites even after adjustment of the covariates (_I am not sure if the adjustment is proper here_).
So we consider this group of metabolites, `r setdiff(metabo.dif, metabo.asso.hyper.strin)`, were influenced by antihypertensive drugs. Further analysis to find which category of drugs influenced the concentration of these metabolites and how the drug influence the related metabolic pathway would be needed.

So Here we classified the metabolites into three groups: i) metabolites associated with hypertension and also blood pressure (not influenced by antihypertensive drugs); ii). metabolites associated influenced by antihypertensive drugs; iii). metabolites associated with blood pressure but not with hypertension.

2. Are the hypertension associated metabolites predictive of furture hypertension
```{r fig.width=3, fig.height=3}
require(pROC)
metabo.asso = names(which(apply(cs_asso[,c(2,4,6)],1,function(x) sum(x!=0))==3))
metabo.diaBPasso = names(which(apply(BP_associat[,c(1,3)],1,function(x) sum(x!=0))==2))
metabo.sysBPasso = names(which(apply(BP_associat[,c(2,4)],1,function(x) sum(x!=0))==2))
clinical = c("ltalteru", "lcsex", "ltsysmm", "ltbmi", "my.alkkon", "my.cigreg", "my.diab", "ll_hdla", "ll_chola", "lh_crp")

##generate cross-validation set
cv_set = f_K_fold(length(which(S4$lthyact==2)), 10)

## glm extension for model evaluation by cross validation 
glm.cv = function(x, f, data, outcome, variable, subset){
  #print(x)
  s = subset[x[[1]]]
  #print(s)
  if(!is.formula(f)){
    stop("It is not a formula!")
  }
  model = glm(f, data = data[s,c(outcome, variable)], family = binomial)
  pred = predict(model ,data[subset[x[[2]]], c(outcome,variable)], type = "response")
  return(pred)
}

pred = lapply(cv_set, glm.cv, f = formula(my.uthyact~.), data = S4, outcome = "my.uthyact", variable = c(metabo.asso, clinical), subset = which(S4$lthyact==2))
pred = unlist(pred)
pred = pred[rownames(S4)[which(S4$lthyact==2)]]
roc.all = roc(S4$my.uthyact[which(S4$lthyact==2)], pred)


pred = lapply(cv_set, glm.cv, f = formula(my.uthyact~.), data = S4, outcome = "my.uthyact", variable = c(metabo.asso), subset = which(S4$lthyact==2))
pred = unlist(pred)
pred = pred[rownames(S4)[which(S4$lthyact==2)]]
roc.metab = roc(S4$my.uthyact[which(S4$lthyact==2)], pred)

pred = lapply(cv_set, glm.cv, f = formula(my.uthyact~.), data = S4, outcome = "my.uthyact", variable = c(clinical), subset = which(S4$lthyact==2))
pred = unlist(pred)
pred = pred[rownames(S4)[which(S4$lthyact==2)]]
roc.clinical = roc(S4$my.uthyact[which(S4$lthyact==2)], pred, ci = TRUE)


plot(roc.all, print.auc = TRUE, grid=TRUE, print.auc.y=ifelse(roc.all$percent, 50, .5))
plot(roc.metabo, add =T,print.auc = TRUE, grid=TRUE, print.auc.y=ifelse(roc.metabo$percent, 60, .6), col = "green")
plot(roc.clinical, add =T,print.auc = TRUE, grid=TRUE, print.auc.y=ifelse(roc.clinical$percent, 70, .7), col = "blue")

```

Using some variable selection methods:
```{r}
require(caret)
data = S4[which(S4$lthyact==2), c(metabo.asso, clinical, "my.uthyact")]
data = na.omit(data)

inTraining = createDataPartition(data$my.uthyact, times =1, p = 0.66, list=T)
training <- data[inTraining[[1]], ]
testing <-data[-inTraining[[1]],]

fitcontrol = trainControl(method = "repeatedcv", number = 10, repeats=10)
#glmFit1 = train(x = training[, c(metabo.asso, clinical)], y = as.factor(training$my.uthyact), method = "glm", family = binomial, trControl=fitcontrol)
#predict(glmFit1$finalModel, testing, type = "response")

##using boosting for variable selection
glmFit1 = train(x = training[, c(metabo.asso, clinical)], y = as.factor(training$my.uthyact), method = "glmboost", family = Binomial(link="logit"), trControl=fitcontrol)
pred = predict(glmFit1$finalModel, as.matrix(testing[,c(metabo.asso, clinical)]), type = "response")
roc.all = roc(testing$my.uthyact,pred)

glmFit1 = train(x = training[, c(metabo.asso)], y = as.factor(training$my.uthyact), method = "glmboost", family = Binomial(link="logit"), trControl=fitcontrol)
pred = predict(glmFit1$finalModel, as.matrix(testing[,c(metabo.asso)]), type = "response")
roc.metabo = roc(testing$my.uthyact,pred)

glmFit1 = train(x = training[, c(clinical)], y = as.factor(training$my.uthyact), method = "glmboost", family = Binomial(link="logit"), trControl=fitcontrol)
pred = predict(glmFit1$finalModel, as.matrix(testing[,c(clinical)]), type = "response")
roc.clinical = roc(testing$my.uthyact,pred)

```


Some other things shoud be put on Todo list:
3. Different medication information could be applied from Margert Heir, who is repsponsible for coding of the medications.


[1]: http://circgenetics.ahajournals.org/content/3/2/207.long "Association of a Peripheral Blood Metabolic Profile With Coronary Artery Disease and Risk of Subsequent Cardiovascular Events"